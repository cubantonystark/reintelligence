<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Properties</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;width:100%;box-sizing:border-box;background:#f8f8fb;font-family:Inter,Arial,system-ui,sans-serif;}
    #header-bar{display:flex;align-items:center;justify-content:center;width:100vw;background:rgba(248,248,251,.92);backdrop-filter:saturate(1.2) blur(6px);box-shadow:0 2px 16px rgba(0,0,0,.08);position:fixed;top:0;left:0;z-index:10001;height:56px;font-size:.95em;padding:0 10px}
    #header-inner{display:flex;flex-direction:row;align-items:center;justify-content:center;width:100%;gap:8px;max-width:1200px}
    #lookup-form{display:flex;align-items:center;gap:6px;flex:1}
    #lookup-input{font-size:.98em;padding:8px 10px;border-radius:9px;border:1px solid #cdd6e1;min-width:60px;width:100%;background:#fff;height:38px}
    #lookup-btn{padding:8px 16px;border-radius:9px;background:#0078D4;color:#fff;border:none;font-size:.96em;cursor:pointer;min-width:86px;transition:background .2s;height:38px;display:flex;align-items:center;gap:6px}
    #lookup-btn:hover{background:#005fa3}
    #lang-toggle{padding:6px 12px;border-radius:9px;background:#273469;color:#fff;border:none;font-size:.93em;cursor:pointer;min-width:56px;transition:background .2s;height:34px;display:flex;align-items:center}
    /* Strong overrides so the model cannot center the Summary card */
.gpt-popup #deal-report [style*="margin:0 auto"], .gpt-popup #deal-report [style*="margin: 0 auto"] { margin-left:0 !important; margin-right:auto !important; }
.gpt-popup #deal-report [style*="text-align:center"] { text-align:left !important; }
.gpt-popup #deal-report [style*="justify-content:center"] { justify-content:flex-start !important; }
.gpt-popup #deal-report [style*="align-items:center"] { align-items:flex-start !important; }
.gpt-popup #deal-report .card, .gpt-popup #deal-report section, .gpt-popup #deal-report article { margin-left:0 !important; margin-right:auto !important; }
.gpt-popup #deal-report .grid { justify-items:start !important; align-items:start !important; }

#map{position:absolute;top:56px;left:0;width:100vw;height:calc(100vh - 56px - var(--quota-h, 0px));min-height:320px;z-index:1}
    #report-overlay-bg{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,40,63,.25);z-index:19998;display:none}
    .gpt-popup{position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:20000;background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.18);box-sizing:border-box;padding:10px 12px 16px;margin:0;overflow-y:auto;overflow-x:hidden;font-family:Inter,Arial,sans-serif;font-size:.92rem;max-width:920px;width:96vw;max-height:calc(100vh - 90px)}
    /* Ensure report content is left-aligned */
    .gpt-popup #deal-report h1, .gpt-popup #deal-report h2, .gpt-popup #deal-report h3, .gpt-popup #deal-report h4, .gpt-popup #deal-report h5, .gpt-popup #deal-report h6, .gpt-popup #deal-report p, .gpt-popup #deal-report ul, .gpt-popup #deal-report ol, .gpt-popup #deal-report li, .gpt-popup #deal-report blockquote { text-align:left !important; }
    .gpt-popup-btns{position:sticky;top:0;z-index:1;background:linear-gradient(#fff,#fff 85%,transparent);display:flex;gap:10px;justify-content:flex-end;margin-bottom:6px;padding-top:6px}
    .gpt-popup-close-btn,.gpt-popup-print-btn{background:#273469;color:#fff;border:none;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:.86em;min-width:64px;height:32px;display:flex;align-items:center;gap:6px}
    .gpt-popup-print-btn{background:#0078D4}
    :root{ --quota-h:0px }
    #quota-bar{position:fixed;left:0;right:0;bottom:0;height:40px;background:#0b63a6;color:#fff;display:flex;align-items:center;gap:10px;padding:0 12px;z-index:10002;font-size:.92rem}
    #quota-user{display:flex;align-items:center;gap:6px}
    #quota-count{font-weight:700}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:38px;min-width:96px;padding:0 14px;border-radius:10px;border:1px solid transparent;background:#eef2f7;color:#0b1324;font-weight:600;cursor:pointer;transition:all .15s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .btn:active{transform:none;box-shadow:none}
    .btn-primary{background:#0078D4;color:#fff;border-color:#0070c8}
    .btn-primary:hover{background:#005fa3;border-color:#00579a}
    .btn-secondary{background:#273469;color:#fff;border-color:#222d5c}
    .btn-secondary:hover{background:#1d2750;border-color:#1a2347}
    .btn-ghost{background:transparent;border-color:#cdd6e1;color:#0b1324}
    .btn-ghost:hover{background:#f5f7fb}
  
    /* analyzing splash */
    #analyzing-splash{
      position:fixed; left:0; top:56px; right:0; bottom:var(--quota-h, 0px);
      display:none; align-items:center; justify-content:center; z-index:19999;
      pointer-events:none;
    }
    .analyzing-card{
      background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.15);
      padding:16px 18px; font-size:1rem; display:flex; align-items:center; gap:10px;
    }
    .analyzing-spinner{
      width:18px; height:18px; border-radius:50%; border:3px solid #e5e7eb; border-top-color:#0078D4;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
    </style>
        
</head>
<body>
  <div id="header-bar">
    <div id="header-inner">
      <form id="lookup-form" onsubmit="propertyLookup(event)">
        <input id="lookup-input" type="text" placeholder="Lookup address or city..." autocomplete="off"/>
        <button id="lookup-btn" type="submit"><span class="material-icons" style="font-size:18px">search</span><span id="lookup-btn-text">Search</span></button>
      </form>
      <button id="lang-toggle" onclick="toggleLanguage()">ES</button>
    </div>
  </div>
  <div id="map"></div>
  <div id="report-overlay-bg"></div>
  <div id="analyzing-splash"><div class="analyzing-card"><div class="analyzing-spinner"></div><div id="analyzing-text">Analyzing...</div></div></div>

  <script>
  // --- i18n bootstrap ---
  window.I18N = window.I18N || {};
  window.currentLanguage = (typeof window.currentLanguage === 'string') ? window.currentLanguage : 'en';
  I18N.en = Object.assign({
    placeholder: "Lookup address or city...",
    search: "Search",
    analyzing: "Analyzing...",
    goodDeal: "Good deal?",
    print: "Print",
    close: "Close",
    price: "Price",
    beds: "Beds",
    baths: "Baths",
    viewListing: "View Listing",
    notFound: "Sorry, we couldn't find a valid property for that input.",
    searchError: "Search error.",
    reportError: "Error generating report.",
    layerStreets: "Streets",
    layerSatellite: "Satellite",
    guest: "Guest",
    loginRegister: "Login/Register",
    logout: "Logout",
    limitReached: "You‚Äôve reached your monthly limit. Please upgrade your plan or buy additional reports.",
    upgrade: "Upgrade",
    buyMore: "Buy additional reports",
    notNow: "Not now",
    login: "Login",
    register: "Register",
    dontHave: "Don't have an account?",
    alreadyHave: "Already have an account?",
    userExists: "That user is already registered. Please try again"
  }, I18N.en || {});
  I18N.es = Object.assign({
    placeholder: "Buscar direcci√≥n o ciudad...",
    search: "Buscar",
    analyzing: "Analizando...",
    goodDeal: "¬øBuena oferta?",
    print: "Imprimir",
    close: "Cerrar",
    price: "Precio",
    beds: "Rec√°maras",
    baths: "Ba√±os",
    viewListing: "Ver en Zillow",
    notFound: "No pudimos encontrar una propiedad v√°lida para esa entrada.",
    searchError: "Error en la b√∫squeda.",
    reportError: "Error generando el informe.",
    layerStreets: "Calles",
    layerSatellite: "Sat√©lite",
    guest: "Invitado",
    loginRegister: "Iniciar/Registrarse",
    logout: "Cerrar sesi√≥n",
    limitReached: "Has alcanzado tu l√≠mite mensual. Por favor, mejora tu plan o compra reportes adicionales.",
    upgrade: "Mejorar plan",
    buyMore: "Comprar reportes adicionales",
    notNow: "Ahora no",
    login: "Iniciar sesi√≥n",
    register: "Registrarse",
    dontHave: "¬øNo tienes cuenta?",
    alreadyHave: "¬øYa tienes cuenta?",
    userExists: "Ese usuario ya est√° registrado. Por favor, int√©ntalo de nuevo."
  }, I18N.es || {});

  function getI18n(){
    try{
      if (window.I18N && I18N[window.currentLanguage]) return I18N[window.currentLanguage];
      if (window.I18N && I18N.en) return I18N.en;
    }catch(_e){}
    return {};
  }
  </script>

  <script>
  // --- Language application + map UI labels ---
  function applyLang(renderMarkersToo=false){
    const splash = document.getElementById('analyzing-text');
    if (splash) { try { splash.innerText = (getI18n().analyzing || 'Analyzing...'); } catch(_e){} }
    const t = getI18n();
    const $ = (id)=>document.getElementById(id);

    var lu = $('lookup-input'); if (lu && t.placeholder) lu.placeholder = t.placeholder;
    var lb = $('lookup-btn-text'); if (lb && t.search) lb.innerText = t.search;

    // Report popup buttons (scoped)
    var printBtn = document.querySelector('#floating-gpt-popup .gpt-popup-print-btn'); if (printBtn && t.print) printBtn.innerText = 'üñ®Ô∏è ' + t.print;
    var closeBtn = document.querySelector('#floating-gpt-popup .gpt-popup-close-btn'); if (closeBtn && t.close) closeBtn.innerText = t.close;

    try { relabelLayers(); } catch(_e){}

    // Always relabel Good deal buttons
    document.querySelectorAll('button[data-good-deal]').forEach(btn => { if (t.goodDeal) btn.innerText = t.goodDeal; });

    // Limit modal
    try {
      var lm = $('limit-msg');
      var b1 = $('limit-upgrade-btn');
      var b2 = $('limit-buy-btn');
      var b3 = $('limit-notnow-btn');
      if (lm) lm.innerText = t.limitReached || "You‚Äôve reached your monthly limit. Please upgrade your plan or buy additional reports.";
      if (b1) b1.innerText = t.upgrade || "Upgrade";
      if (b2) b2.innerText = t.buyMore || "Buy additional reports";
      if (b3) b3.innerText = t.notNow || "Not now";
    } catch(_e){}

    // Auth modal localization
    try {
      var title = $('auth-title');
      var submitBtn = $('auth-submit');
      var toggleText = $('auth-toggle-text');
      var toggleLink = $('auth-toggle-link');
      var hint = $('auth-hint');
      var mode = (window._authMode === 'register') ? 'register' : 'login';
      if (mode === 'login') {
        if (title) title.innerText = t.login || 'Login';
        if (submitBtn) submitBtn.innerText = t.login || 'Login';
        if (hint) hint.style.display = 'block';
        if (toggleText) toggleText.innerText = t.dontHave || "Don't have an account?";
        if (toggleLink) toggleLink.innerText = t.register || 'Register';
      } else {
        if (title) title.innerText = t.register || 'Register';
        if (submitBtn) submitBtn.innerText = t.register || 'Register';
        if (hint) hint.style.display = 'none';
        if (toggleText) toggleText.innerText = t.alreadyHave || 'Already have an account?';
        if (toggleLink) toggleLink.innerText = t.login || 'Login';
      }
    } catch(_e){}
  }

  function toggleLanguage(){
    window.currentLanguage = (window.currentLanguage === "en") ? "es" : "en";
    var btn = document.getElementById('lang-toggle');
    if (btn) btn.innerText = (window.currentLanguage === "en") ? "ES" : "EN";
    try { applyLang(true);   try { if (typeof refreshCounterBar === 'function') refreshCounterBar(); } catch(_e){}
} catch(_e){}
    try {
      if (typeof updateHouseIcons === 'function' && Array.isArray(window.markerData) && markerData.length) {
        updateHouseIcons(true); // rebuild marker popups and keep the open one
      }
    } catch(_e){}
  }
  </script>

  <script>
  // --- Leaflet map + markers ---
  var markers = [];
  var markerData = [];
  var satelliteLayer = null;
  var streetsLayer = null;
  var layersControl = null;

  function makeHouseIcon(){
    return L.divIcon({
      html:"<span style='font-size:2em;'>&#127968;</span>",
      iconSize:[32,32], iconAnchor:[16,32], className:"leaflet-house-icon"
    });
  }

  function getLeafletMap(){
    if (window._mobile_map_ref) return window._mobile_map_ref;
    for (var k in window){
      if(k.startsWith('map_') && window[k] && typeof window[k]==='object' && typeof window[k].getCenter==='function') return window[k];
    }
    return null;
  }

  function createLeafletMap(lat,lng,zoom){
    satelliteLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution:'Tiles ¬© Esri', maxZoom:19 }
    );
    streetsLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'¬© OpenStreetMap', maxZoom:19 }
    );
    var map = L.map('map', { center:[lat,lng], zoom:zoom, layers:[streetsLayer] });
    window._mobile_map_ref = map;
    buildLayersControl();
    map.on('popupclose', function(){ if (window._propertyFocus) { window._propertyFocus = false; if (typeof immediateRefresh === 'function') immediateRefresh(); }});
    return map;
  }

  function buildLayersControl(){
    var map = getLeafletMap();
    if (!map) return;
    if (layersControl) { try { map.removeControl(layersControl); } catch(e){} }
    const t = getI18n();
    const baseLayers = {};
    baseLayers[t.layerSatellite] = satelliteLayer;
    baseLayers[t.layerStreets] = streetsLayer;
    layersControl = L.control.layers(baseLayers, {}).addTo(map);
  }

  function relabelLayers(){
    var map = getLeafletMap();
    if (!map) return;
    const active = map.hasLayer(satelliteLayer) ? 'sat' : 'str';
    buildLayersControl();
    if (active === 'sat') {
      if (!map.hasLayer(satelliteLayer)) { map.addLayer(satelliteLayer); if (map.hasLayer(streetsLayer)) map.removeLayer(streetsLayer); }
    } else {
      if (!map.hasLayer(streetsLayer)) { map.addLayer(streetsLayer); if (map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer); }
    }
  }

  function htmlEscape(str){
    return (''+str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }
  function sanitizeHtml(txt){
    if(!txt) return "";
    txt = txt.replace(/(^|\n)\s*```[a-zA-Z]*\s*\n?/g, '$1');
    txt = txt.replace(/\n?\s*```\s*(\n|$)/g, '\n');
    return txt;
  }

  function updateHouseIcons(keepPopup=false){
    const t = getI18n();
    var map = getLeafletMap();
    let openLatLng = null;
    if (keepPopup && map && map._popup && map._popup._latlng) { openLatLng = map._popup._latlng; }
    markers.forEach(m => map.removeLayer(m)); markers = [];
    markerData.forEach(function(home){
      var icon = makeHouseIcon();
      var priceLabel = typeof home.price === 'number' ? home.price.toLocaleString() : home.price;
      const addr = htmlEscape(home.address);
      const detailsUrl = home.detail_url ? `https://www.zillow.com${home.detail_url}` : null;
      var html = `
        <div style="max-width:260px">
          <span style='font-size:1.5em;'>&#127968;</span> <b>${addr}</b><br>
          ${priceLabel && priceLabel!=='No price' ? `${t.price}: $${priceLabel}<br>` : ``}
          ${t.beds}: ${home.bedrooms} | ${t.baths}: ${home.bathrooms}<br>
          ${detailsUrl ? `<a href='${detailsUrl}' target='_blank'>${t.viewListing}</a><br>` : ``}
          ${home.img_url ? `<img src='${home.img_url}' width='280' style='max-width:90vw;border-radius:8px;margin-top:6px;'>` : ``}
          <div style="margin-top:8px">
            <button data-good-deal class="btn btn-ghost" onclick="sendClickedInfo('${addr}', '${priceLabel}', '${home.bedrooms}', '${home.bathrooms}', '${home.last_sold_amount}', ${home.lat}, ${home.lon})">${t.goodDeal}</button>
          </div>
        </div>
      `;
      var marker = L.marker([home.lat, home.lon], {icon}); marker.addTo(map).bindPopup(html);
      markers.push(marker);
    });
    if (keepPopup && openLatLng){
      const found = markers.find(m => m.getLatLng() && m.getLatLng().lat===openLatLng.lat && m.getLatLng().lng===openLatLng.lng);
      if (found) found.openPopup();
    }
  }

  function setupMapRefresh(retry=0){
    var map = getLeafletMap();
    if(!map){
      if(retry<20){ setTimeout(()=>setupMapRefresh(retry+1),400); }
      else { alert("Leaflet Map not found!"); }
      return;
    }
    function clearMarkers(){ markers.forEach(m => map.removeLayer(m)); markers = []; }

    function refreshHomes(){
      if (window._propertyFocus) return;
      var b = map.getBounds(), c = map.getCenter();
      var payload = {
        sw_lat:b.getSouthWest().lat, sw_lng:b.getSouthWest().lng,
        ne_lat:b.getNorthEast().lat, ne_lng:b.getNorthEast().lng,
        center_lat:c.lat, center_lng:c.lng,
        zoom: map.getZoom()
      };
      axios.post('/refresh', payload).then(function(r){
        var data = r.data || [];
        if (Array.isArray(data) && data.length > 0){
          clearMarkers();
          markerData = data;
          updateHouseIcons();
          applyLang();
        }
      }).catch(function(err){
        console.error("Refresh error", err);
      });
    }

    function immediateRefresh(){
      var b = map.getBounds(), c = map.getCenter();
      var payload = {
        sw_lat:b.getSouthWest().lat, sw_lng:b.getSouthWest().lng,
        ne_lat:b.getNorthEast().lat, ne_lng:b.getNorthEast().lng,
        center_lat:c.lat, center_lng:c.lng,
        zoom: map.getZoom()
      };
      axios.post('/refresh', payload).then(function(r){
        var data = r.data || [];
        if (Array.isArray(data) && data.length > 0){
          markers.forEach(m => map.removeLayer(m));
          markers = [];
          markerData = data;
          updateHouseIcons();
          applyLang();
        }
      }).catch(function(err){
        console.error("Refresh error", err);
      });
    }
    window.immediateRefresh = immediateRefresh;

    function delayed(){ setTimeout(refreshHomes, 600); }
    map.on('moveend', delayed);
    map.on('zoomend', delayed);
    refreshHomes();
  }

  function propertyLookup(e){
    e.preventDefault();
    var val = document.getElementById('lookup-input').value.trim();
    if (!val) return;
    axios.post('/lookup', { q: val })
      .then(function(res){
        var data = res.data || {};
        var map = getLeafletMap();
        if (data.mode === 'property' && data.home) {
          window._propertyFocus = true;
          map.setView([data.center.lat, data.center.lng], 17);
          markerData = [data.home];
          updateHouseIcons();
          applyLang();
          if (markers[0]) markers[0].openPopup();
        } else if (data.mode === 'place' && data.center) {
          window._propertyFocus = false;
          map.setView([data.center.lat, data.center.lng], data.zoom || 16);
          setTimeout(function(){ if (typeof immediateRefresh === 'function') immediateRefresh(); }, 50);
        } else {
          alert(getI18n().notFound);
        }
      })
      .catch(function(err){
        const msg = err && err.response && err.response.data && err.response.data.message ? err.response.data.message : getI18n().searchError;
        alert(msg);
      });
  }

  function showAnalyzing(){
    var overlayBg = document.getElementById("report-overlay-bg");
    if (overlayBg) overlayBg.style.display = "block";
    var splash = document.getElementById("analyzing-splash");
    var txt = document.getElementById("analyzing-text");
    if (txt) { try { txt.innerText = (getI18n().analyzing || 'Analyzing...'); } catch(_e){} }
    if (splash) splash.style.display = "flex";
  }
  function hideAnalyzing(){
    var splash = document.getElementById("analyzing-splash");
    if (splash) splash.style.display = "none";
  }

  async function sendClickedInfo(address, price, bedrooms, bathrooms, last_sold_amount, lat, lon){
    try{
      const r = await fetch('/auth/status', {cache:'no-store', credentials:'same-origin'});
      if(!r.ok){ openAuthModal('login'); return; }
      const st = await r.json();
      if(!st.is_logged_in){ openAuthModal('login'); return; }
      if((st.count||0) <= 0){ openLimitModal(); return; }
    }catch(_e){ openAuthModal('login'); return; }

    try {
      showAnalyzing();
      const response = await axios.post('/clicked', { address, price, bedrooms, bathrooms, last_sold_amount, language: (window.currentLanguage||'en'), lat, lon });
      var data = response.data || {};
      var raw = data.html || data.report || "<div>Error generating report.</div>";
      var html = sanitizeHtml(raw);
      var overlayBg = document.getElementById("report-overlay-bg"); if(overlayBg) overlayBg.style.display = "block";
      var oldPopup = document.getElementById("floating-gpt-popup"); if (oldPopup) oldPopup.remove();
      var popupDiv = document.createElement("div"); popupDiv.className="gpt-popup"; popupDiv.id="floating-gpt-popup";
      var hdr = document.createElement("div"); hdr.className="gpt-popup-btns";
      var closeBtn = document.createElement("button"); closeBtn.className="gpt-popup-btn gpt-popup-close-btn"; closeBtn.innerText=getI18n().close || 'Close'; closeBtn.onclick=function(){ closeReportOverlay(); };
      var printBtn = document.createElement("button"); printBtn.className="gpt-popup-btn gpt-popup-print-btn"; printBtn.innerText='üñ®Ô∏è ' + (getI18n().print || 'Print'); printBtn.onclick=function(){ window.print(); };
      hdr.appendChild(closeBtn); hdr.appendChild(printBtn); popupDiv.appendChild(hdr);
      var content = document.createElement("div"); content.innerHTML = html; popupDiv.appendChild(content);
      document.body.appendChild(popupDiv);
      hideAnalyzing();
    } catch (err) {
      var status = err && err.response && err.response.status;
      if (status === 403) {
        const j = err.response.data || {};
        const msg = (j && j.message) ? j.message : "Authentication required.";
        if (String(msg).toLowerCase().includes("limit")) openLimitModal();
        else openAuthModal('login');
        return;
      }
      hideAnalyzing();
      alert(getI18n().reportError || 'Error generating report.');
    }
  }

  function closeReportOverlay(){
    var overlayBg = document.getElementById("report-overlay-bg"); if(overlayBg) overlayBg.style.display = "none";
    var oldPopup = document.getElementById("floating-gpt-popup"); if (oldPopup) oldPopup.remove();
  }
  </script>

  <script>
  // ===== Quota bar + Auth wiring (single clean block) =====
  (function(){
    function ensureQuotaBar(){
      var bar = document.getElementById('quota-bar');
      if(!bar){
        bar = document.createElement('div');
        bar.id="quota-bar";
        document.body.appendChild(bar);
      }
      bar.style.cssText = "position:fixed;left:0;right:0;bottom:0;height:40px;background:#0b63a6;color:#fff;display:flex;align-items:center;gap:10px;padding:0 12px;z-index:10002;font-size:.92rem";
      if (!bar.innerHTML || bar.innerHTML.indexOf('quota-user') === -1){
        bar.innerHTML = '<div id="quota-user"></div><span id="quota-count" style="display:none"></span>' + '<span id="quota-copyright" style="margin-left:auto">&copy; 2025 REintelligence.app</span>';
      }
      return bar;
    }
    window.ensureQuotaBar = ensureQuotaBar;

    window.renderQuotaBar = function(state){
      var t = getI18n();
      var bar = ensureQuotaBar();
      var userSpan = document.getElementById('quota-user');
      var countEl = document.getElementById('quota-count');

      if (state && state.is_logged_in) {
        userSpan.innerHTML = '<span class="material-icons" style="font-size:18px">person</span>'
          + '<span id="quota-user-name"></span> ‚Äî <span id="quota-count"></span> ‚Äî '
          + '<a href="#" id="quota-logout-link" style="color:#fff;text-decoration:underline">' + (t.logout || 'Logout') + '</a>';
        var nameEl = document.getElementById('quota-user-name');
        if (nameEl) nameEl.innerText = state.user || 'user';
        var ce = document.getElementById('quota-count');
        if (ce) ce.innerText = String(state.count||0) + '/' + String(state.max||0);
        var lo = document.getElementById('quota-logout-link');
        if (lo) lo.onclick = function(ev){ ev.preventDefault(); try{ authLogout(); }catch(_e){} };
        if (countEl) countEl.style.display = '';
      } else {
        userSpan.innerHTML = '<span class="material-icons" style="font-size:18px">person</span>'
          + (t.guest || 'Guest') + ' - <a href="#" id="quota-login-link" style="color:#fff;text-decoration:underline">'
          + (t.loginRegister || 'Login/Register') + '</a>';
        var ln = document.getElementById('quota-login-link');
        if (ln) ln.onclick = function(ev){ ev.preventDefault(); try{ openAuthModal("login"); }catch(_e){} };
        if (countEl) countEl.style.display = 'none';
      }
      document.documentElement.style.setProperty('--quota-h','40px');
    };

    window.refreshCounterBar = function(){
      try { renderQuotaBar({ is_logged_in:false }); } catch(_e){}
      fetch('/auth/status', { cache:'no-store', credentials:'same-origin' })
        .then(function(r){ return r.ok ? r.json() : { is_logged_in:false }; })
        .then(function(st){ try { renderQuotaBar(st); } catch(_e){} })
        .catch(function(){ try { renderQuotaBar({ is_logged_in:false }); } catch(_e){} });
    };

    document.addEventListener('DOMContentLoaded', function(){ try{ refreshCounterBar(); }catch(_e){} });
    document.addEventListener('visibilitychange', function(){ if(!document.hidden){ try{ refreshCounterBar(); }catch(_e){} } });
  })();
  </script>

  <!-- Auth Modal -->
  <div id="auth-overlay" style="display:none; position:fixed; inset:0; background:rgba(2,6,23,.45); z-index:21000;" onclick="closeAuthModal()"></div>
  <div id="auth-modal" class="gpt-popup" style="display:none; z-index:21001; max-width:420px; width:92%; border-radius:16px; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:14px;" onclick="event.stopPropagation()">
    <button type="button" id="auth-close-x" aria-label="Close" onclick="closeAuthModal()" style="position:absolute;top:8px;right:10px;background:transparent;border:0;font-size:18px;line-height:1;cursor:pointer;padding:4px 6px;">√ó</button>
    <div id="auth-title" style="font-weight:700; font-size:1.05rem; margin:2px 0 10px;">Login</div>
    <div id="auth-error" style="display:none; color:#b91c1c; font-weight:600; margin-bottom:8px;"></div>
    <div style="display:grid; grid-template-columns: 1fr; gap:8px;">
      <label>Username <input id="auth-username" type="text" placeholder="username" style="width:100%; height:38px; border:1px solid rgba(2,6,23,.12); border-radius:10px; padding:0 10px;"></label>
      <label>Password <input id="auth-password" type="password" placeholder="password" style="width:100%; height:38px; border:1px solid rgba(2,6,23,.12); border-radius:10px; padding:0 10px;"></label>
      <div id="auth-hint" style="font-size:.9em; color:#64748b;">Dev test user: <b>rey</b> / <b>R34n3l.2025</b> (5 reports)</div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
        <button id="auth-submit" class="btn btn-primary" onclick="submitAuth()">Login</button>
      </div>
      <div id="auth-toggle-line" style="display:flex; gap:6px; justify-content:center; margin-top:6px; font-size:.9em; color:#64748b;">
        <span id="auth-toggle-text">Don't have an account?</span>
        <a href="#" id="auth-toggle-link" onclick="event.preventDefault(); switchAuthTab('register')">Register</a>
      </div>
    </div>
  </div>

  <script>
  // ---- Auth modal logic (clean) ----
  (function(){
    window._authMode = 'login';

    function i18n(){ return getI18n(); }

    window.openAuthModal = function(mode){
      window._authMode = (mode === 'register') ? 'register' : 'login';
      switchAuthTab(window._authMode);
      try { applyLang(); } catch(_e){}
      var ov=document.getElementById('auth-overlay'); if (ov) ov.style.display='block';
      var m=document.getElementById('auth-modal'); if (m) m.style.display='block';
    };

    window.closeAuthModal = function(){
      var ov=document.getElementById('auth-overlay'); if (ov) ov.style.display='none';
      var m=document.getElementById('auth-modal'); if (m) m.style.display='none';
    };

    window.switchAuthTab = function(mode){
      window._authMode = (mode === 'register') ? 'register' : 'login';
      var t = i18n();
      var title = document.getElementById('auth-title');
      var hint = document.getElementById('auth-hint');
      var submitBtn = document.getElementById('auth-submit');
      var toggleText = document.getElementById('auth-toggle-text');
      var toggleLink = document.getElementById('auth-toggle-link');

      if(window._authMode === 'login'){
        if(title) title.innerText = t.login || 'Login';
        if(submitBtn) submitBtn.innerText = t.login || 'Login';
        if(hint) hint.style.display = 'block';
        if(toggleText) toggleText.innerText = (t.dontHave || "Don't have an account?");
        if(toggleLink) toggleLink.innerText = t.register || 'Register';
      } else {
        if(title) title.innerText = t.register || 'Register';
        if(submitBtn) submitBtn.innerText = t.register || 'Register';
        if(hint) hint.style.display = 'none';
        if(toggleText) toggleText.innerText = (t.alreadyHave || 'Already have an account?');
        if(toggleLink) toggleLink.innerText = t.login || 'Login';
      }
    };

    window.setAuthError = function(msg){
      var el=document.getElementById('auth-error');
      if(!el) return;
      if(!msg){ el.style.display='none'; el.innerText=''; }
      else { el.style.display='block'; el.innerText=msg; }
    };

    window.submitAuth = function(){
      setAuthError('');
      var u = document.getElementById('auth-username').value.trim();
      var p = document.getElementById('auth-password').value;
      if(!u || !p){ setAuthError('Enter username and password.'); return; }
      var url = (window._authMode==='register') ? '/auth/register' : '/auth/login';
      var body = {username:u, password:p}; if(window._authMode==='register'){ body.starting_quota = 5; }
      fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify(body)})
        .then(function(r){ return r.json().then(function(j){ return {ok:r.ok, j:j}; }); })
        .then(async function(res){
          var ok = res.ok, j = res.j;
          if(!ok || j.ok===false){ setAuthError(j.error || 'Auth failed'); return; }
          closeAuthModal();
          if(typeof renderQuotaBar==='function'){ renderQuotaBar({is_logged_in:true, user:(j.user||u), count:(j.count||0), max:(j.max||0)}); }
          try{
            var s = await fetch('/auth/status', {cache:'no-store', credentials:'same-origin'});
            if(s.ok){ var st = await s.json(); if(typeof renderQuotaBar==='function') renderQuotaBar(st); }
          }catch(_e){}
        })
        .catch(function(){ setAuthError('Network error'); });
    };
  })();
  </script>

  <!-- Limit Reached Modal -->
  <div id="limit-overlay" style="display:none; position:fixed; inset:0; background:rgba(2,6,23,.45); z-index:22000;" onclick="closeLimitModal()"></div>
  <div id="limit-modal" class="gpt-popup" style="display:none; z-index:22001; max-width:460px; width:92%; border-radius:16px; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:16px;" onclick="event.stopPropagation()">
    <button type="button" id="limit-close-x" aria-label="Close" onclick="closeLimitModal()" style="position:absolute;top:8px;right:10px;background:transparent;border:0;font-size:18px;line-height:1;cursor:pointer;padding:4px 6px;">√ó</button>
    <div id="limit-msg" style="font-weight:600; font-size:1.05rem; line-height:1.45; color:#0b1324; margin:8px 0 18px;">You‚Äôve reached your monthly limit. Please upgrade your plan or buy additional reports.</div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="limit-notnow-btn" class="btn btn-ghost" onclick="closeLimitModal()">Not now</button>
      <button id="limit-buy-btn" class="btn btn-secondary" onclick="goBuyMore()">Buy additional reports</button>
      <button id="limit-upgrade-btn" class="btn btn-primary" onclick="goUpgrade()">Upgrade</button>
    </div>
  </div>
  <script>
  function openLimitModal(){
    try { applyLang(); } catch(_e){}
    var o = document.getElementById('limit-overlay');
    var m = document.getElementById('limit-modal');
    if (o) o.style.display = 'block';
    if (m) m.style.display = 'block';
  }
  function closeLimitModal(){
    var o = document.getElementById('limit-overlay');
    var m = document.getElementById('limit-modal');
    if (o) o.style.display = 'none';
    if (m) m.style.display = 'none';
  }
  function goUpgrade(){ closeLimitModal(); window.location.href = '/'; }
  function goBuyMore(){ closeLimitModal(); window.location.href = '/'; }
  </script>

  <script>
  // --- Map init ---
  (function(){
    function ensureMapInit(){
      try{
        var hasContainer = document.getElementById('map');
        if(!hasContainer) return;
        var map = getLeafletMap();
        if(!map && typeof createLeafletMap === 'function'){
          createLeafletMap(27.9506, -82.4572, 12); // Tampa, FL
        }
        setTimeout(function(){
          try{ if (typeof setupMapRefresh === 'function') setupMapRefresh(); }catch(_e){}
          try{ if (typeof immediateRefresh === 'function') immediateRefresh(); }catch(_e){}
        }, 0);
      }catch(_e){}
    }
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', ensureMapInit);
    } else {
      ensureMapInit();
    }
  })();
  </script>

  <script>
  function authLogout(){
    try { renderQuotaBar({ is_logged_in:false }); } catch(_e){}
    fetch('/auth/logout', { method:'POST', credentials:'same-origin' })
      .catch(function(){})
      .finally(function(){ try { refreshCounterBar(); } catch(_e){} });
  }
  </script>
</body>
</html>
