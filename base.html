<!DOCTYPE html>
<html>
<head>
    <title>Properties</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Material Icons for section headers and animated splash -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- PDF export support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body { position: relative; }
        #map {
            height: 95vh;
            width: 100vw;
            min-height: 400px;
            min-width: 100vw;
        }
        .leaflet-house-icon {
            background: none !important;
            border: none !important;
        }
        .house-red {
            color: #d00;
            text-shadow: 0 2px 4px #fff;
        }
        .house-blue {
            color: #0078D4;
            text-shadow: 0 2px 4px #fff;
        }
        .gpt-popup {
            width: 900px;
            max-width: 90vw;
            min-width: 320px;
            height: auto;
            max-height: 90vh;
            min-height: 320px;
            overflow-x: auto;
            overflow-y: auto;
            font-family: 'Nunito', 'Quicksand', 'Arial', sans-serif;
            font-size: 1rem;
            padding: 10px;
            box-sizing: border-box;
            background: #f8f8fb;
            border-radius: 16px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.17);
            position: relative;
        }
        .print-link, .pdf-link {
            position: absolute;
            top: 10px;
            z-index: 2;
            font-family: Arial,sans-serif;
            font-size: 15px;
        }
        .print-link { right: 18px; }
        .pdf-link { right: 90px; }
        #splashScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #splashScreenContent {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.17);
            padding: 30px 50px;
            text-align: center;
            font-size: 1.3em;
            color: #0078D4;
        }
        .splash-spinner {
            display: inline-block;
            width: 2.7em;
            height: 2.7em;
            border: 0.35em solid #e0e7ef;
            border-top: 0.35em solid #0078D4;
            border-radius: 50%;
            animation: splash-spin 1s linear infinite;
            margin-bottom: 12px;
            vertical-align: middle;
        }
        @keyframes splash-spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        .report-card-header {
            background: #fff;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 18px 22px 10px 22px;
            font-family: 'Nunito', 'Quicksand', 'Arial', sans-serif;
            text-align: left;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .report-title {
            font-size: 1.22em;
            font-weight: 700;
            color: #1a355d;
            margin-bottom: 2px;
            margin-top: 0;
            line-height: 1.15em;
        }
        .report-price {
            font-size: 1.08em;
            font-weight: 500;
            color: #4b5b6b;
            margin-bottom: 2px;
            line-height: 1.07em;
        }
        .report-grade {
            font-size: 1.10em;
            font-weight: bold;
            color: #35a47f;
            background: #e9f7ef;
            border-radius: 8px;
            padding: 2px 12px;
            margin-bottom: 0;
            margin-top: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            display: inline-block;
        }
        .report-section {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin: 18px 0;
            padding: 18px 22px;
            font-family: 'Nunito', 'Quicksand', 'Arial', sans-serif;
        }
        .report-section h2, .report-section h3 {
            font-size: 1.2em;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a355d;
            display: flex;
            align-items: center;
        }
        .material-icons {
            font-size: 1.15em !important;
            margin-right: 0.3em;
            vertical-align: middle;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            margin-bottom: 10px;
            font-size: 0.98em;
            overflow-x: auto;
            display: block;
        }
        .report-table th, .report-table td {
            padding: 8px 10px;
            text-align: left;
        }
        .report-table th {
            background: #e8eaf6;
            color: #273469;
        }
        .report-table tr:nth-child(even) {
            background: #f7f7fc;
        }
        .report-table tr:nth-child(odd) {
            background: #fff;
        }
        .pros-cons-container {
            display: flex;
            gap: 16px;
            width: 100%;
        }
        .pros-box, .cons-box {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            font-size: 1em;
            margin-top: 6px;
            font-family: 'Nunito', 'Quicksand', 'Arial', sans-serif;
        }
        .pros-box {
            background: #e6f7e6;
            color: #217a3a;
            border: 1px solid #b2e5c9;
        }
        .cons-box {
            background: #ffeaea;
            color: #b63d3d;
            border: 1px solid #f7cccc;
        }
        .bottom-line {
            font-size: 1.07em;
            font-weight: 500;
            color: #1a355d;
            background: #f2f7fa;
            border-radius: 8px;
            padding: 12px 20px;
            margin-top: 16px;
        }
        .next-steps {
            margin-top: 8px;
            padding-left: 22px;
            font-size: 1em;
        }
        .fine-print-wrapper {
            width: 100%;
            margin-top: 18px;
            margin-bottom: 0;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: flex-start;
        }
        .fine-print-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 700px;
        }
        .fine-print {
            background: none;
            font-size: 1.08em;
            color: #7c8a99;
            font-family: 'Nunito', 'Quicksand', 'Arial', sans-serif;
            text-align: left;
            line-height: 1.5em;
            padding: 0 10px 0 0;
            font-style: italic;
            border-radius: 5px;
            margin-bottom: 4px;
            letter-spacing: .2px;
            box-shadow: 0 0 0 transparent;
        }
        .fine-print .scoring {
            font-weight: 700;
            color: #53616d;
            font-size: 1.11em;
            text-shadow: 0 1px 2px #f8f8fb;
            font-family: 'Quicksand', 'Nunito', 'Arial', sans-serif;
            margin-bottom: 2px;
        }
        @media (max-width: 900px) {
            .gpt-popup {
                width: 95vw;
                max-width: 98vw;
                min-width: 320px;
            }
            .fine-print-wrapper {
                max-width: 95vw;
            }
            .fine-print-block {
                max-width: 95vw;
            }
            .fine-print {
                font-size: 1em;
                padding: 0 4vw 0 0;
            }
        }
        @media (max-width: 768px) {
            .pros-cons-container {
                flex-direction: column !important;
                gap: 0.7em !important;
                width: 100%;
            }
            .pros-box, .cons-box {
                margin-top: 0.7em;
                margin-bottom: 0.7em;
                width: 100%;
            }
            .report-table {
                font-size: 0.94em;
            }
            .fine-print-wrapper {
                flex-direction: column;
                align-items: flex-start;
                margin-top: 16px;
            }
            .fine-print-block {
                max-width: 99vw;
            }
            .fine-print {
                font-size: 0.95em;
                padding: 0 2vw 0 0;
                margin-bottom: 3px;
            }
        }
        @media (max-width: 600px) {
            #map {
                height: 92vh;
                min-height: 350px;
            }
            .gpt-popup {
                width: 98vw;
                max-width: 98vw;
                height: 55vh;
                min-width: 98vw;
                font-size: 1em;
            }
            #splashScreenContent {
                padding: 20px 10px;
                font-size: 1em;
            }
            .report-card-header, .report-section, .pros-box, .cons-box, .bottom-line {
                padding: 10px 8px;
                font-size: 0.95em;
            }
            .report-card-header { font-size: 1em; }
            .report-table th, .report-table td { padding: 6px 4px; font-size: 0.9em; }
            .report-table { font-size: 0.91em; }
            .fine-print-block {
                max-width: 99vw;
            }
            .fine-print {
                font-size: 0.95em;
                padding: 0 2vw 0 0;
                margin-bottom: 3px;
            }
        }
        @media (max-width: 400px) {
            .gpt-popup {
                width: 99vw;
                max-width: 99vw;
                min-width: 99vw;
                height: 50vh;
                font-size: 0.88em;
            }
            .fine-print-block {
                max-width: 99vw;
            }
            .fine-print {
                font-size: 0.88em;
                padding: 0 1vw 0 0;
                margin-bottom: 2px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="splashScreen">
        <div id="splashScreenContent">
            <span class="splash-spinner"></span><br>
            <span>Analyzing...</span>
        </div>
    </div>
    <script>
        // --- All previous JS is unchanged except the following block ---
        function sendClickedInfo(address, price, bedrooms, bathrooms, last_sold_amount) {
            showSplash();
            axios.post('/clicked', { address, price, bedrooms, bathrooms, last_sold_amount })
                .then(function(response) {
                    hideSplash();
                    var html = response.data.report;
                    // Remove all fine print blocks from the report HTML
                    html = html.replace(/<div class="fine-print[\s\S]*?<\/div>/gi, "");
                    html = html.replace(/<div class="fine-print-wrapper[\s\S]*?<\/div>/gi, "");
                    // Remove last sold price from header, tables, or anywhere in the HTML
                    html = html.replace(/Last Sold Price:.*?<br>/gi, "");
                    html = html.replace(/Last Sold Price:.*?\n/gi, "");
                    html = html.replace(/Last Sold Price:.*?<\/div>/gi, "");
                    html = html.replace(/Last Sold:.*?<br>/gi, "");
                    html = html.replace(/Last Sold:.*?\n/gi, "");
                    html = html.replace(/Last Sold:.*?<\/div>/gi, "");
                    html = html.replace(/Last Sold Price<\/th>/gi, "");
                    html = html.replace(/<td.*?>N\/A<\/td>/gi, "");
                    html = html.replace(/<th[^>]*>Last Sold Price<\/th>/gi, "");
                    html = html.replace(/<td[^>]*>N\/A<\/td>/gi, "");
                    html = html.replace(/<td[^>]*>\$?N\/A<\/td>/gi, "");
                    html = html.replace(/<td[^>]*>\$?0<\/td>/gi, "");
                    // Replace header with compact version (address, price, grade only)
                    html = html.replace(/<div[^>]*class="report-card-header"[^>]*>[\s\S]*?<\/div>/gi, 
                        `<div class="report-card-header">
                            <div class="report-title">${address}</div>
                            <div class="report-price">Listed Price: ${price}</div>
                            <div class="report-grade">Grade: <span id="grade-value"></span></div>
                        </div>`
                    );
                    // Extract grade from GPT output if present
                    var gradeMatch = html.match(/Overall Grade:\s*([A-F])/i);
                    var grade = gradeMatch ? gradeMatch[1] : "";
                    var popupDiv = document.createElement('div');
                    popupDiv.className = 'gpt-popup';
                    // Print link
                    var printLink = document.createElement('a');
                    printLink.href = "#";
                    printLink.className = "print-link";
                    printLink.innerHTML = "🖨️ Print";
                    printLink.onclick = function(e) {
                        e.preventDefault();
                        printPopupReport(popupDiv, address);
                    };
                    // PDF link
                    var pdfLink = document.createElement('a');
                    pdfLink.href = "#";
                    pdfLink.className = "pdf-link";
                    pdfLink.innerHTML = "⬇️ PDF";
                    pdfLink.onclick = function(e) {
                        e.preventDefault();
                        var clone = popupDiv.cloneNode(true);
                        var printLinks = clone.getElementsByClassName('print-link');
                        while (printLinks.length > 0) printLinks[0].parentNode.removeChild(printLinks[0]);
                        var pdfLinks = clone.getElementsByClassName('pdf-link');
                        while (pdfLinks.length > 0) pdfLinks[0].parentNode.removeChild(pdfLinks[0]);
                        clone.style.maxHeight = "none";
                        clone.style.overflow = "visible";
                        html2pdf().set({
                            margin: 0.3,
                            filename: (address || 'Investment_Report') + '.pdf',
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true },
                            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                        }).from(clone).save();
                    };
                    popupDiv.appendChild(printLink);
                    popupDiv.appendChild(pdfLink);
                    var contentDiv = document.createElement('div');
                    contentDiv.innerHTML = html;
                    popupDiv.appendChild(contentDiv);
                    // Set grade value in compact header
                    var gradeSpan = popupDiv.querySelector('#grade-value');
                    if (gradeSpan) gradeSpan.textContent = grade;
                    // Always append fine print block at the very bottom
                    var finePrintBlock = document.createElement('div');
                    finePrintBlock.innerHTML = `
                        <div class="fine-print-wrapper">
                            <div class="fine-print-block">
                                <div class="fine-print scoring">
                                    Scoring: A = Excellent investment; B = Good; C = Average; D = Below average; F = Poor investment.
                                </div>
                                <div class="fine-print">
                                    Real estate investments, like all investments, involve inherent risks and are not guaranteed to be profitable. Any information or content provided regarding real estate investment is for informational purposes only and should not be construed as financial, legal, tax, or investment advice.
                                </div>
                            </div>
                        </div>`;
                    popupDiv.appendChild(finePrintBlock);
                    var gptPopup = L.popup({
                        maxWidth: "900px",
                        minWidth: "320px",
                        maxHeight: "90vh",
                        minHeight: "320px"
                    })
                    .setContent(popupDiv);
                    var map = getLeafletMap();
                    if(map) {
                        gptPopup.setLatLng(map.getCenter()).openOn(map);
                    }
                }).catch(function() {
                    hideSplash();
                    alert("Error generating report. Please try again.");
                });
        }
        // --- All other JS unchanged ---
    </script>
</body>
</html>
