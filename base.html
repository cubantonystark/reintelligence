<!DOCTYPE html>
<html lang="en">
<head>
  <title>Properties</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;width:100%;box-sizing:border-box;background:#f8f8fb;font-family:Inter,Arial,system-ui,sans-serif;}
    #header-bar{display:flex;align-items:center;justify-content:center;width:100vw;background:rgba(248,248,251,.92);backdrop-filter:saturate(1.2) blur(6px);box-shadow:0 2px 16px rgba(0,0,0,.08);position:fixed;top:0;left:0;z-index:10001;height:56px;font-size:.95em;padding:0 10px}
    #header-inner{display:flex;flex-direction:row;align-items:center;justify-content:center;width:100%;gap:8px;max-width:1200px}
    #lookup-form{display:flex;align-items:center;gap:6px;flex:1}
    #lookup-input{font-size:.98em;padding:8px 10px;border-radius:9px;border:1px solid #cdd6e1;min-width:60px;width:100%;background:#fff;height:38px}
    #lookup-btn{padding:8px 16px;border-radius:9px;background:#0078D4;color:#fff;border:none;font-size:.96em;cursor:pointer;min-width:86px;transition:background .2s;height:38px;display:flex;align-items:center;gap:6px}
    #lookup-btn:hover{background:#005fa3}
    #lang-toggle{padding:6px 12px;border-radius:9px;background:#273469;color:#fff;border:none;font-size:.93em;cursor:pointer;min-width:56px;transition:background .2s;height:34px;display:flex;align-items:center}
    #map{position:absolute;top:56px;left:0;width:100vw;height:calc(100vh - 56px);min-height:320px;z-index:1}
    /* Spinner only for "Good deal?" */
    #splashScreen{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,.85);z-index:19999;display:none;align-items:center;justify-content:center;padding:12px}
    #splashScreenContent{background:#fff;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,.17);padding:16px 18px;text-align:center;font-size:.97em;color:#0078D4;max-width:320px}
    .splash-spinner{display:inline-block;width:2.1em;height:2.1em;border:.32em solid #e0e7ef;border-top:.32em solid #0078D4;border-radius:50%;animation:splash-spin 1s linear infinite;margin-bottom:10px;vertical-align:middle}
    @keyframes splash-spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #report-overlay-bg{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,40,63,.25);z-index:19998;display:none}
    .gpt-popup{position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:20000;background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.18);box-sizing:border-box;padding:10px 12px 16px;margin:0;overflow-y:auto;overflow-x:hidden;font-family:Inter,Arial,sans-serif;font-size:.92rem;max-width:920px;width:96vw;max-height:calc(100vh - 90px)}
    .gpt-popup-btns{position:sticky;top:0;z-index:1;background:linear-gradient(#fff,#fff 85%,transparent);display:flex;gap:10px;justify-content:flex-end;margin-bottom:6px;padding-top:6px}
    .gpt-popup-close-btn,.gpt-popup-print-btn{background:#273469;color:#fff;border:none;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:.86em;min-width:64px;height:32px;display:flex;align-items:center;gap:6px}
    .gpt-popup-print-btn{background:#0078D4}
    @media (max-width:650px){
      .gpt-popup{ top:56px; left:0; transform:none; width:100vw; max-width:100vw; height:calc(100vh - 56px); max-height:calc(100vh - 56px); border-radius:0 }
      .gpt-popup-btns{padding:8px}
    }
    .good-deal-btn{padding:6px 10px;border-radius:8px;border:1px solid #cdd6e1;background:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div id="header-bar">
    <div id="header-inner">
      <form id="lookup-form" onsubmit="propertyLookup(event)">
        <input id="lookup-input" type="text" placeholder="Lookup address or city..." autocomplete="off"/>
        <button id="lookup-btn" type="submit"><span class="material-icons" style="font-size:18px">search</span><span id="lookup-btn-text">Search</span></button>
      </form>
      <button id="lang-toggle" onclick="toggleLanguage()">ES</button>
    </div>
  </div>
  <div id="map"></div>

  <!-- Spinner kept ONLY for ‚ÄúGood deal?‚Äù flow -->
  <div id="splashScreen">
    <div id="splashScreenContent">
      <span class="splash-spinner"></span><br>
      <span id="splash-text">Analyzing...</span>
    </div>
  </div>
  <div id="report-overlay-bg"></div>

  <script>
    // --------- i18n (UI + Layers) ----------
    var currentLanguage = "en";
    const I18N = {
      en: {
        placeholder: "Lookup address or city...",
        search: "Search",
        analyzing: "Analyzing...",
        goodDeal: "Good deal?",
        print: "Print",
        close: "Close",
        price: "Price",
        beds: "Beds",
        baths: "Baths",
        viewListing: "View Listing",
        notFound: "Sorry, we couldn't find a valid property for that input.",
        searchError: "Search error.",
        reportError: "Error generating report.",
        layerStreets: "Streets",
        layerSatellite: "Satellite"
      },
      es: {
        placeholder: "Buscar direcci√≥n o ciudad...",
        search: "Buscar",
        analyzing: "Analizando...",
        goodDeal: "¬øBuena oferta?",
        print: "Imprimir",
        close: "Cerrar",
        price: "Precio",
        beds: "Rec√°maras",
        baths: "Ba√±os",
        viewListing: "Ver en Zillow",
        notFound: "No pudimos encontrar una propiedad v√°lida para esa entrada.",
        searchError: "Error en la b√∫squeda.",
        reportError: "Error generando el informe.",
        layerStreets: "Calles",
        layerSatellite: "Sat√©lite"
      }
    };

    function applyLang(renderMarkersToo = false){
      const t = I18N[currentLanguage];
      const $ = (id)=>document.getElementById(id);
      $('lookup-input').placeholder = t.placeholder;
      $('lookup-btn-text').innerText = t.search;
      $('splash-text').innerText = t.analyzing;
      const printBtn = document.querySelector('.gpt-popup-print-btn'); if (printBtn) printBtn.innerText = "üñ®Ô∏è " + t.print;
      const closeBtn = document.querySelector('.gpt-popup-close-btn'); if (closeBtn) closeBtn.innerText = t.close;

      // Rebuild layer control with localized labels
      relabelLayers();

      if (renderMarkersToo) {
        updateHouseIcons(true);
      } else {
        document.querySelectorAll('button[data-good-deal]').forEach(btn => btn.innerText = t.goodDeal);
      }
    }

    function toggleLanguage(){
      currentLanguage = currentLanguage === "en" ? "es" : "en";
      document.getElementById('lang-toggle').innerText = currentLanguage === "en" ? "ES" : "EN";
      applyLang(true);
    }

    // --------- Map + Layers + Markers ----------
    window._propertyFocus = false;
    var markers = [];
    var markerData = [];
    var refreshTimeout = null;
    var REFRESH_DELAY_MS = 1800;

    var satelliteLayer = null;
    var streetsLayer = null;
    var layersControl = null;

    function makeHouseIcon(){
      return L.divIcon({
        html:"<span style='font-size:2em;'>&#127968;</span>",
        iconSize:[32,32], iconAnchor:[16,32], className:"leaflet-house-icon"
      });
    }

    function getLeafletMap(){
      if (window._mobile_map_ref) return window._mobile_map_ref;
      for (var k in window){
        if(k.startsWith('map_') && window[k] && typeof window[k]==='object' && typeof window[k].getCenter==='function') return window[k];
      }
      return null;
    }

    function createLeafletMap(lat,lng,zoom){
      satelliteLayer = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution:'Tiles ¬© Esri', maxZoom:19 }
      );
      streetsLayer = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution:'¬© OpenStreetMap', maxZoom:19 }
      );

      var map = L.map('map', { center:[lat,lng], zoom:zoom, layers:[streetsLayer] });
      window._mobile_map_ref = map;

      buildLayersControl();

      map.on('popupclose', function(){
        if (window._propertyFocus) {
          window._propertyFocus = false;
          if (typeof immediateRefresh === 'function') immediateRefresh();
        }
      });
      return map;
    }

    function buildLayersControl(){
      var map = getLeafletMap();
      if (!map) return;
      if (layersControl) {
        try { map.removeControl(layersControl); } catch(e){}
      }
      const t = I18N[currentLanguage];
      const baseLayers = {};
      baseLayers[t.layerSatellite] = satelliteLayer;
      baseLayers[t.layerStreets] = streetsLayer;
      layersControl = L.control.layers(baseLayers, {}).addTo(map);
    }

    function relabelLayers(){
      var map = getLeafletMap();
      if (!map) return;
      const active = map.hasLayer(satelliteLayer) ? 'sat' : 'str';
      buildLayersControl();
      if (active === 'sat') {
        if (!map.hasLayer(satelliteLayer)) {
          map.addLayer(satelliteLayer);
          if (map.hasLayer(streetsLayer)) map.removeLayer(streetsLayer);
        }
      } else {
        if (!map.hasLayer(streetsLayer)) {
          map.addLayer(streetsLayer);
          if (map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer);
        }
      }
    }

    function sanitizeHtml(txt){
  if(!txt) return "";
  // Remove Markdown code fences like ``` or ```html anywhere in the text
  txt = txt.replace(/(^|\n)\s*```[a-zA-Z]*\s*\n?/g, '$1');
  txt = txt.replace(/\n?\s*```\s*(\n|$)/g, '\n');
  return txt;
}

function htmlEscape(str){
      return (''+str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function updateHouseIcons(keepPopup=false){
      const t = I18N[currentLanguage];
      var map = getLeafletMap();
      let openLatLng = null;
      if (keepPopup && map && map._popup && map._popup._latlng) {
        openLatLng = map._popup._latlng;
      }
      markers.forEach(m => map.removeLayer(m)); markers = [];
      markerData.forEach(function(home){
        var icon = makeHouseIcon();
        var priceLabel = typeof home.price === 'number' ? home.price.toLocaleString() : home.price;
        const addr = htmlEscape(home.address);
        const detailsUrl = home.detail_url ? `https://www.zillow.com${home.detail_url}` : null;
        var html = `
          <div style="max-width:260px">
            <span style='font-size:1.5em;'>&#127968;</span> <b>${addr}</b><br>
            ${priceLabel && priceLabel!=='No price' ? `${t.price}: $${priceLabel}<br>` : ``}
            ${t.beds}: ${home.bedrooms} | ${t.baths}: ${home.bathrooms}<br>
            ${detailsUrl ? `<a href='${detailsUrl}' target='_blank'>${t.viewListing}</a><br>` : ``}
            ${home.img_url ? `<img src='${home.img_url}' width='150' style='max-width:90vw;border-radius:8px;margin-top:6px;'>` : ``}
            <div style="margin-top:8px">
              <button data-good-deal class="good-deal-btn" onclick="sendClickedInfo('${addr}', '${priceLabel}', '${home.bedrooms}', '${home.bathrooms}', '${home.last_sold_amount}', ${home.lat}, ${home.lon})">${t.goodDeal}</button>
            </div>
          </div>
        `;
        var marker = L.marker([home.lat, home.lon], {icon}); marker.addTo(map).bindPopup(html);
        markers.push(marker);
      });
      if (keepPopup && openLatLng){
        const found = markers.find(m => m.getLatLng() && m.getLatLng().lat===openLatLng.lat && m.getLatLng().lng===openLatLng.lng);
        if (found) found.openPopup();
      }
    }

    function setupMapRefresh(retry=0){
      var map = getLeafletMap();
      if(!map){
        if(retry<20){ setTimeout(()=>setupMapRefresh(retry+1),400); }
        else { alert("Leaflet Map not found!"); }
        return;
      }
      function clearMarkers(){ markers.forEach(m => map.removeLayer(m)); markers = []; }

      function refreshHomes(){
        if (window._propertyFocus) return;
        var b = map.getBounds(), c = map.getCenter();
        var payload = {
          sw_lat:b.getSouthWest().lat, sw_lng:b.getSouthWest().lng,
          ne_lat:b.getNorthEast().lat, ne_lng:b.getNorthEast().lng,
          center_lat:c.lat, center_lng:c.lng,
          zoom: map.getZoom()
        };
        axios.post('/refresh', payload).then(function(r){
          clearMarkers();
          markerData = r.data || [];
          updateHouseIcons();
          applyLang(); // ensure current language on UI bits
        }).catch(function(err){
          console.error("Refresh error", err);
        });
      }

      function immediateRefresh(){
        var b = map.getBounds(), c = map.getCenter();
        var payload = {
          sw_lat:b.getSouthWest().lat, sw_lng:b.getSouthWest().lng,
          ne_lat:b.getNorthEast().lat, ne_lng:b.getNorthEast().lng,
          center_lat:c.lat, center_lng:c.lng,
          zoom: map.getZoom()
        };
        axios.post('/refresh', payload).then(function(r){
          markers.forEach(m => map.removeLayer(m)); markers=[];
          markerData = r.data || [];
          updateHouseIcons();
          applyLang();
        }).catch(function(err){
          console.error("Refresh error", err);
        });
      }
      window.immediateRefresh = immediateRefresh;

      function delayed(){ if(refreshTimeout) clearTimeout(refreshTimeout); refreshTimeout = setTimeout(refreshHomes, REFRESH_DELAY_MS); }
      map.on('moveend', delayed);
      map.on('zoomend', delayed);
      refreshHomes();
    }

    function propertyLookup(e){
      e.preventDefault();
      var val = document.getElementById('lookup-input').value.trim();
      if (!val) return;
      axios.post('/lookup', { q: val })
        .then(function(res){
          var data = res.data || {};
          var map = getLeafletMap();
          if (data.mode === 'property' && data.home) {
            window._propertyFocus = true;
            map.setView([data.center.lat, data.center.lng], 17); // address-level
            markerData = [data.home];
            updateHouseIcons();
            applyLang();
            if (markers[0]) markers[0].openPopup();
          } else if (data.mode === 'place' && data.center) {
            window._propertyFocus = false;
            map.setView([data.center.lat, data.center.lng], data.zoom || 16); // city-level close
            setTimeout(function(){ if (typeof immediateRefresh === 'function') immediateRefresh(); }, 50);
          } else {
            alert(I18N[currentLanguage].notFound);
          }
        })
        .catch(function(err){
          const msg = err?.response?.data?.message || I18N[currentLanguage].searchError;
          alert(msg);
        });
    }

    // Spinner helpers (ONLY for ‚ÄúGood deal?‚Äù)
    function showSplash(){ document.getElementById('splashScreen').style.display='flex'; }
    function hideSplash(){ document.getElementById('splashScreen').style.display='none'; }

    // GPT analysis popup
    function sendClickedInfo(address, price, bedrooms, bathrooms, last_sold_amount, lat, lon) {
      showSplash();
      axios.post('/clicked', { address, price, bedrooms, bathrooms, last_sold_amount, language: currentLanguage, lat, lon })
        .then(function(response){
          hideSplash();
          var raw = response.data.html || response.data.report || "<div>Error generating report.</div>";
          var html = sanitizeHtml(raw);
          var overlayBg = document.getElementById("report-overlay-bg");
          overlayBg.style.display = "block";
          var oldPopup = document.getElementById("floating-gpt-popup"); if (oldPopup) oldPopup.remove();
          var popupDiv = document.createElement("div"); popupDiv.className="gpt-popup"; popupDiv.id="floating-gpt-popup";

          var btnBar = document.createElement("div"); btnBar.className="gpt-popup-btns";
          var closeBtn = document.createElement("button"); closeBtn.className="gpt-popup-close-btn"; closeBtn.innerText=I18N[currentLanguage].close;
          closeBtn.onclick=function(){ overlayBg.style.display = "none"; popupDiv.remove(); };
          var printBtn = document.createElement("button"); printBtn.className="gpt-popup-print-btn"; printBtn.innerText="üñ®Ô∏è " + I18N[currentLanguage].print;
          printBtn.onclick=function(){ var w=window.open('','','width=900,height=700'); w.document.write(html); w.document.close(); w.focus(); setTimeout(function(){ w.print(); }, 250); };

          btnBar.appendChild(printBtn); btnBar.appendChild(closeBtn);
          popupDiv.appendChild(btnBar);

          var content=document.createElement("div"); content.innerHTML=html; popupDiv.appendChild(content);
          document.body.appendChild(popupDiv);

          overlayBg.onclick=function(){ overlayBg.style.display="none"; var floating=document.getElementById("floating-gpt-popup"); if(floating) floating.remove(); };
        })
        .catch(function(){
          hideSplash();
          alert(I18N[currentLanguage].reportError);
        });
    }

    // Geolocation (desktop + mobile) on initial load
    (function init(){
      applyLang();
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(pos){
          var lat = pos.coords.latitude, lng = pos.coords.longitude;
          createLeafletMap(lat, lng, 15);
          setupMapRefresh();
        }, function(){
          createLeafletMap(27.9506, -82.4572, 12); // Tampa fallback
          setupMapRefresh();
        }, { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });
      } else {
        createLeafletMap(27.9506, -82.4572, 12);
        setupMapRefresh();
      }
    })();
  </script>
</body>
</html>
